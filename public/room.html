<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Крутилка</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container landing">
        <h1>Крутилка</h1>

        <div id="loading">Загрузка...</div>

        <!-- Приём открыт -->
        <div id="openView" style="display:none">
            <h2 id="topic" class="topic"></h2>
            <form id="entryForm" class="create-form">
                <label for="authorInput">Ваше имя</label>
                <input type="text" id="authorInput" placeholder="Например: Иван" required>
                <label for="valueInput">Ваш вариант</label>
                <input type="text" id="valueInput" placeholder="Например: Пицца" required>
                <button type="submit">Отправить</button>
            </form>
            <div id="submitted" class="result" style="display:none">
                Отправлено! Админ крутанёт колесо, когда все будут готовы.
            </div>
        </div>

        <!-- Приём закрыт -->
        <div id="closedView" style="display:none">
            <h2 id="topicClosed" class="topic"></h2>
            <div class="result">Приём вариантов закрыт. Скоро крутанут колесо!</div>
        </div>

        <!-- Победитель -->
        <div id="finishedView" style="display:none">
            <h2 id="topicFinished" class="topic"></h2>
            <div class="result winner" id="winnerResult"></div>
        </div>
    </div>

    <script>
        const roomId = window.location.pathname.split('/')[2];

        async function load() {
            const res = await fetch(`/api/rooms/${roomId}`);
            if (!res.ok) {
                document.getElementById('loading').textContent = 'Комната не найдена.';
                return;
            }
            const room = await res.json();
            document.getElementById('loading').style.display = 'none';

            if (room.status === 'open') {
                document.getElementById('openView').style.display = 'block';
                document.getElementById('topic').textContent = room.topic;
            } else if (room.status === 'closed') {
                document.getElementById('closedView').style.display = 'block';
                document.getElementById('topicClosed').textContent = room.topic;
            } else if (room.status === 'finished') {
                document.getElementById('finishedView').style.display = 'block';
                document.getElementById('topicFinished').textContent = room.topic;
                document.getElementById('winnerResult').textContent = `Победитель: ${room.winner}`;
            }
        }

        load();

        document.getElementById('entryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const author = document.getElementById('authorInput').value.trim();
            const value = document.getElementById('valueInput').value.trim();
            if (!author || !value) return;

            const res = await fetch(`/api/rooms/${roomId}/entries`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ author, value }),
            });

            if (res.ok) {
                document.getElementById('entryForm').style.display = 'none';
                document.getElementById('submitted').style.display = 'block';
            } else {
                const err = await res.json();
                alert(err.error || 'Не удалось отправить');
            }
        });
    </script>
</body>
</html>
